<tal:block define="mode options/mode;
  id here/getWidgetId;
  value_name here/getHtmlWidgetId;
  fields here/fields;
  current_filename options/current_filename;
  empty_file options/empty_file;
  session_file options/session_file;
  mimetype options/mimetype;
  size options/size;
  content_url options/content_url;
  last_modified options/last_modified;
  content_url_nocache string:${content_url}?nocache=${last_modified};
  image_tag options/image_tag;
  image_width options/width;
  image_height options/height;
  subtitle options/subtitle;
  title options/title;
  rposition options/render_position;
  configurable options/configurable;
  last_modified options/last_modified;
  photo_path python:content_url and '/'.join(content_url.split('/')[:-3]) or '';
  original_photo_field python:len(fields)>3 and fields[3] or 'photo_original'
  ">
  <div class="photoWidget"
       tal:condition="python: mode == 'view' and not empty_file"
       tal:define="original_photo python:getattr(here,original_photo_field, None)">
    <p tal:attributes="class python:test(rposition == 'right', 'dright',
                                      test(rposition == 'center', 'dcenter', 'dleft'))">
      <tal:block condition="python: original_photo">
        <a href="#"
          tal:define="original_width python:original_photo.width or 100;
                      original_height python:original_photo.height or 100"
          tal:attributes="onclick python:'window.open(\'%s/popup_photo?id=%s\',\'original_image\',\'innerwidth=%s'%(photo_path,original_photo_field,str(int(original_width)+40)) +
                         ',innerheight=%s'%str(int(original_height) + 40) +
                         ',width=%s'%str(int(original_width)+40) +
                         ',height=%s'%str(int(original_height) + 40) +
                         ',location=no,menubar=no' +
                         ',personalbar=no,toolbar=no,status=no,resizable=yes' +
                         ',scrollbars=yes\');;return false;;'"><img tal:replace="structure image_tag" /></a>
      </tal:block>
      <tal:block condition="not: original_photo">
        <img tal:replace="structure image_tag" />
      </tal:block>
      <tal:block condition="subtitle">
        <br/>
        <span tal:attributes="style string:width:${image_width}px"
              tal:content="subtitle" />
      </tal:block>
    </p>
  </div>

  <tal:block condition="python: mode == 'edit'">
    <img tal:condition="python: not empty_file and not session_file"
      tal:replace="structure image_tag" />

    <tal:block define="allow_resize here/allow_resize|nothing;
                       keep_original here/keep_original|nothing;
                       can_keep_original python:allow_resize and keep_original and len(fields)>3 or 0">
    <metal:block use-macro="here/widget_image_render/macros/image_edit">
      <metal:block fill-slot="edit_file_action"
        tal:condition="python:not empty_file and can_keep_original">
        <li>
          <input type="radio" class="noborder" name="." value="resize"
                 tal:attributes="name radio_name;
                                 id string:${radio_name}_resize" />
          <label i18n:translate="cpsschemas_label_image_resize"
                 tal:attributes="for string:${radio_name}_resize">resize</label>
          <select tal:attributes="name string:${name}_resize_kept;
            onchange string:document.getElementById('${radio_name}_resize').checked='checked';"
            tal:define="wid_size python:(here.display_width,
                                         here.display_height);
                        sizes python:[s for s in here.getImgSizes()
                                        if not wid_size[0]
                                           or s['size'] < wid_size]">
            <option tal:repeat="op sizes"
              tal:attributes="value op/id;
              selected python: op['size'] and (op['size'][0]==image_width
                                               or op['size'][1]==image_height)"
              i18n:translate=""
              ><span tal:replace="op/id" /> <span tal:condition="op/size"
                i18n:name="dim"
                tal:content="python:'(%sx%s)' % op['size']">
                640x480</span></option>
          </select>
        </li>
      </metal:block>
    </metal:block>
    </tal:block>

    <tal:block condition="python:len(fields) > 2 and 'position' in configurable">
      <p tal:define="name here/getHtmlWidgetId">
        <tal:block i18n:translate="cpsschemas_render_position">
          Render position
        </tal:block>
        <select tal:attributes="name string:${value_name}_rposition">
          <option tal:repeat="op here/all_render_positions"
            tal:attributes="selected python:op == rposition;
                            value op"
            tal:content="string:cpsschemas_rposition_${op}"
            i18n:translate="" />
        </select>
      </p>
    </tal:block>

    <tal:block condition="python:len(fields) > 4">
      <p>
      <tal:block i18n:translate="cpsschemas_image_title">
        Image title :
      </tal:block>
      <input type="text" size="30"
             tal:attributes="name string:${value_name}_title;
                             value title" />
      </p>
    </tal:block>

    <tal:block condition="python:len(fields) > 1">
      <p>
      <tal:block i18n:translate="cpsschemas_photo_subtitle">
        Photo subtitle :
      </tal:block>
      <input type="text" size="30"
             tal:attributes="name string:${value_name}_subtitle;
                             value subtitle" />
      </p>
    </tal:block>

  </tal:block>

</tal:block>
