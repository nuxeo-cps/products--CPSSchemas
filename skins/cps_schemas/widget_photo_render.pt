<tal:block define="mode options/mode;
  id here/getWidgetId;
  value_name here/getHtmlWidgetId;
  fields here/fields;
  current_name options/current_name;
  current_title options/current_title;
  empty_file options/empty_file;
  mimetype options/mimetype;
  size options/size;
  content_url options/content_url;
  image_tag options/image_tag;
  image_width options/width;
  subtitle options/subtitle;
  rposition options/render_position;
  configurable options/configurable;
  last_modified options/last_modified;
  photo_path python:content_url and '/'.join(content_url.split('/')[:-3]) or '';
  original_photo_field python:len(fields)>3 and fields[3] or 'photo_original'
  ">
  <tal:block condition="python: mode == 'view' and not empty_file" 
             define="original_photo python:getattr(here,original_photo_field, None)">
    <div tal:attributes="class python:test(rposition == 'right', 'dright',
                                      test(rposition == 'center', 'dcenter', 'dleft'))">
      <tal:block condition="python: original_photo">
        <a href="#" 
          tal:define="original_width python:original_photo.width; 
                      original_height python:original_photo.height"
          tal:attributes="onClick python:'window.open(\'%s/popup_photo?id=%s\',\'original_image\',\'innerwidth=%s'%(photo_path,original_photo_field,str(int(original_width)+40)) +
                         ',innerheight=%s'%str(int(original_height) + 40) +
                         ',width=%s'%str(int(original_width)+40) +
                         ',height=%s'%str(int(original_height) + 40) +
                         ',location=no,menubar=no' +
                         ',personalbar=no,toolbar=no,status=no,resizable=no' +
                         ',scrollbars=yes\')'"><img tal:replace="structure image_tag" /></a>
      </tal:block>
      <tal:block condition="not: original_photo">
        <img tal:replace="structure image_tag" />
      </tal:block>
      <div tal:condition="subtitle"
           style="width: 100px;"
           tal:attributes="style python:'width: %spx;;' % image_width">
        <small tal:content="subtitle" />
      </div>
    </div>
  </tal:block>

  <tal:block condition="python: mode == 'edit'">
    <metal:block use-macro="here/widget_image_render/macros/image_title_edit" />

    <img tal:condition="python: not empty_file"
      tal:replace="structure image_tag" />

    <tal:block define="allow_resize here/allow_resize|nothing;
                       keep_original here/keep_original|nothing;
                       can_keep_original python:allow_resize and keep_original and len(fields)>3 or 0">
    <metal:block use-macro="here/widget_image_render/macros/image_edit">
      <metal:block fill-slot="edit_file_action"
        tal:condition="python:not empty_file and can_keep_original">
        <li>
          <input type="radio" class="noborder" name="." value="resize"
                 tal:attributes="name radio_name;
                                 id string:${radio_name}_resize" />
          <label i18n:translate="cpsschemas_label_image_resize"
                 tal:attributes="for string:${radio_name}_resize">resize</label>
          <select tal:attributes="name string:${name}_resize_kept;
            onchange string:document.getElementById('${radio_name}_resize').checked='checked';"
            tal:define="wid_size python:(here.display_width, here.display_height);
            sizes python:[s for s in here.getImgSizes() if not wid_size[0] or s['size'] < wid_size]">
            <option tal:repeat="op sizes"
                    tal:attributes="value op/id"
                    tal:content="op/id" i18n:translate="" />
          </select>
        </li>
      </metal:block>
    </metal:block>
    </tal:block>

    <tal:block condition="python:len(fields) > 2 and configurable.find('position')>=0">
      <p tal:define="name here/getHtmlWidgetId;
                     title_name string:${name}_title;">
        <span i18n:translate="cpsschemas_render_position">
          Render position
        </span>
        <select tal:attributes="name string:${value_name}_rposition">
          <option tal:repeat="op here/all_render_positions"
            tal:attributes="selected python:op == rposition;
                            value op"
            tal:content="string:cpsschemas_rposition_${op}"
            i18n:translate="" />
        </select>
      </p>
    </tal:block>

    <tal:block condition="python:len(fields)>1">
      <span i18n:translate="cpsschemas_photo_subtitle">
        Photo subtitle
      </span>
      <input type="text" size="30"
             tal:attributes="name string:${value_name}_subtitle;
                             value subtitle" />
    </tal:block>

  </tal:block>

</tal:block>
