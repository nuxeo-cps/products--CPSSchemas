# 
# This should work even when there is a symbolic link in the path.
# 
ZOPE_HOME=/usr/lib/zope2.7
INSTANCE_HOME=$(shell python -c "import os.path; print os.path.normpath('$(PWD)/../../..')")
SOFTWARE_HOME=$(ZOPE_HOME)/lib/python
PYTHON=$(ZOPE_HOME)/bin/python
PYTHONPATH=$(INSTANCE_HOME)/lib/python

.PHONY: test clean coverage

test:
	INSTANCE_HOME=$(INSTANCE_HOME) \
	SOFTWARE_HOME=$(SOFTWARE_HOME) \
	PYTHONPATH=$(PYTHONPATH) \
	$(PYTHON) runalltests.py

cover:
	mkdir cover

coverage: cover
	INSTANCE_HOME=$(INSTANCE_HOME) \
	SOFTWARE_HOME=$(SOFTWARE_HOME) \
	PYTHONPATH=$(PYTHONPATH) \
	$(PYTHON) coverage.py -x runalltests.py
	$(PYTHON) coverage.py -r ../*.py
	$(PYTHON) coverage.py -a -d cover ../*.py
	echo "Annotated files saved in cover/*.py,cover"

clean:
	rm -rf *.pyc *~ cover .coverage
